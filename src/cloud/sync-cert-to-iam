sync-cert-to-iam () {
    FILE_LIST="cert.pem privkey.pem chain.pem"
    DATE=`date '+%Y-%m-%d-%H%M%S'`
    SITES=$(list-certs)

    if ! $(has-command aws); then
        install-aws
    fi

    if [ "$SITES" == "" ]; then
        return
    fi

    echo "Uploading certificates to IAM, please don't cancel during this operation"

    for SITE_NAME in $SITES
    do
        echo "Uploading certificates for site: $SITE_NAME  -->  $SITE_NAME-$DATE"
        missing_certfile=0

        for cert_file in $FILE_LIST;
        do
            file_path="$LOCAL_PATH/$SITE_NAME/$cert_file"

            if [ ! -f $file_path ]; then
                echo " - Missing $cert_file"
                missing_certfile=1
            fi
        done

        if [ missing_certfile = 1 ]; then
            echo "[ERROR] Missing certificate file for $SITE_NAME"
            continue
        fi

        # Upload new certificate to IAM
        aws iam upload-server-certificate \
            --server-certificate-name "$SITE_NAME-$DATE" \
            --certificate-body "file:///$LOCAL_PATH/$SITE_NAME/cert.pem" \
            --private-key "file:///$LOCAL_PATH/$SITE_NAME/privkey.pem" \
            --certificate-chain "file:///$LOCAL_PATH/$SITE_NAME/chain.pem" &&
        # Rename certificate
        aws iam update-server-certificate \
            --server-certificate-name "$SITE_NAME-$DATE" \
            --new-server-certificate-name "$SITE_NAME"
    done
}